<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Megastar Ferry</title><!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"><!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" type="text/css">
  <link rel="stylesheet" href="https://demos.creative-tim.com/argon-dashboard/assets/vendor/nucleo/css/nucleo.css" type="text/css"><!-- CSS -->
  <link rel="stylesheet" href="https://demos.creative-tim.com/argon-dashboard/assets/css/argon.min.css?v=1.2.0" type="text/css">
  <style>
      /* The Modal (background) */
        .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        }

        /* The Close Button */
        .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        }

        .close:hover,
        .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
        }

        .switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}

/* Style inputs with type="text", select elements and textareas */
input[type=text], select, textarea {
  width: 100%; /* Full width */
  padding: 12px; /* Some padding */ 
  border: 1px solid #ccc; /* Gray border */
  border-radius: 4px; /* Rounded borders */
  box-sizing: border-box; /* Make sure that padding and width stays in place */
  margin-top: 6px; /* Add a top margin */
  margin-bottom: 16px; /* Bottom margin */
  resize: vertical /* Allow the user to vertically resize the textarea (not horizontally) */
}

/* Style the submit button with a specific background color etc */
input[type=submit] {
  background-color: #04AA6D;
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* When moving the mouse over the submit button, add a darker green color */
input[type=submit]:hover {
  background-color: #45a049;
}

/* Add a background color and some padding around the form */
.container {
  border-radius: 5px;
  background-color: #f2f2f2;
  padding: 20px;
}
  </style>
</head>

<body>
    <!-- The Modal -->
<div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
        <span class="close">&times;</span>
        <!-- <div class="container">
            <form action="action_page.php">
          
              <label for="fname">Longitude</label>
              <input type="text" id="Longitude" name="firstname" >
          
              <label for="lname">Latitude</label>
              <input type="text" id="Latitude" name="lastname">

              <label for="fname">Speed</label>
              <input type="text" id="Speed" name="firstname">
          
              <label for="lname">Course</label>
              <input type="text" id="Course" name="lastname">

              <label for="fname">Heading</label>
              <input type="text" id="Heading" name="firstname" >
          
            </form>
        </div> -->
      <!-- Rounded switch -->
      <p id= "modelInd"> Toggle switch to select Models</p>
    <label class="switch">
        <input type="checkbox" id="myCheck" onClick="myCheckBoxFunction()">
        <span class="slider round"></span>
    </label>
    </div>
  
  </div>

  <div class="main-content" id="panel">
      <nav class="navbar navbar-top navbar-expand navbar-dark border-bottom bg-dark" id="navbarTop" data-toggle="modal" data-target="#navbarModal">
          <div class="container-fluid">
              <div class="collapse navbar-collapse" id="navbarSupportedContent">

                  <ul class="navbar-nav align-items-center  ml-auto ml-md-0 ">
                      <li class="nav-item dropdown"><a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <div class="media align-items-center"><span class="avatar avatar-sm rounded-circle"><img alt="Image placeholder" src="https://th.bing.com/th/id/R3b54b3e3ccc6c56c0551173a21c7435c?rik=DaAOrhvibL9T%2fg&pid=ImgRaw"></span>
                                  <div class="media-body  ml-2  d-none d-lg-block"><span class="mb-0 text-sm  font-weight-bold">Megastar</span></div>
                              </div>
                          </a>
                          <div class="dropdown-menu dropdown-menu-right">
                              <div class="dropdown-header noti-title">
                                  <h6 class="text-overflow m-0">Welcome!</h6>
                              </div><a href="#!" class="dropdown-item"><i class="fa fa-user"></i><span>My profile</span></a><a href="#!" class="dropdown-item"><i class="fa fa-tools"></i><span>Settings</span></a><a href="#!" class="dropdown-item"><i class="far fa-calendar"></i><span>Activity</span></a> <a href="#!" class="dropdown-item"><i class="fa fa-phone"></i><span>Support</span></a>
                              <div class="dropdown-divider"></div><a href="#!" class="dropdown-item"><i class="fa fa-sign-out-alt"></i><span>Logout</span></a>
                          </div>
                      </li>
                  </ul>
              </div>
          </div>
      </nav>
      <div class="container-fluid pt-3">
          <div class="row removable">
              <div class="col-lg-12">
                  <div class="card card-stats">
                      <div class="card-body">
                          <div class="row">
                              <div class="col">
                                  <h5 class="card-title text-uppercase text-muted mb-0" id="predictedCityInd">Predicted Time Of Arrival To Helsinki</h5><span class="h2 font-weight-bold mb-0" id="ETA">2,356</span>
                              </div>
                              <div class="col-auto">
                                  <div class="icon icon-shape bg-orange text-white rounded-circle shadow"><i class="fa fa-chart-pie"></i></div>
                              </div>
                          </div>
                          <p class="mt-3 mb-0 text-sm" id="normalStatus"><span class="text-success mr-2"><i class="fa fa-check"></i> <span>Status : Normal Route Movement</span></p>
                          <p class="mt-3 mb-0 text-sm" id="warningStatus"><span class="text-warning mr-2"><i class="fa fa-flag-checkered"></i> <span>Status : Anomaly in current Route due to abnormal movement of ship or if ship is at port or press the settings button to load correct model </span></p>
                      </div>
                  </div>
              </div>
          </div>
          <div class="row removable">
              <div class="col-lg-6">
                <script type="text/javascript">
                  width='100%';		// the width of the embedded map in pixels or percentage
                  height='100%';		// the height of the embedded map in pixels or percentage
                  border='0';		// the width of the border around the map (zero means no border)
                  shownames='true';	// to display ship names on the map (true or false)
                  latitude='59.835118635248804';	// the latitude of the center of the map, in decimal degrees
                  longitude='24.851873059808067';	// the longitude of the center of the map, in decimal degrees , 
                  zoom='15';		// the zoom level of the map (values between 2 and 17)
                  maptype='0';		// use 0 for Normal Map, 1 for Satellite
                  trackvessel='276829000';	// MMSI of a vessel (note: vessel will be displayed only if within range of the system) - overrides "zoom" option
                  fleet='';		// the registered email address of a user-defined fleet (user's default fleet is used)
                </script>
                <script type="text/javascript" src="https://www.marinetraffic.com/js/embed.js"></script>
              </div>
              <div class="col-lg-6">
                  <div class="card">
                      <div class="card-header border-0">
                          <div class="row align-items-center">
                              <div class="col">
                                  <h3 class="mb-0">Position History</h3>
                              </div>
                          </div>
                      </div>
                      <div class="table-responsive">
                          <table class="table align-items-center table-flush" id="myTable">
                              <thead class="thead-light">
                                  <tr>
                                      <th scope="col">Latitude</th>
                                      <th scope="col">Longitude</th>
                                      <th scope="col">Speed</th>
                                      <th scope="col">Direction</th>
                                  </tr>
                              </thead>
                              <tbody>
                                
                              </tbody>
                          </table>
                      </div>
                  </div>
                  <div class="card">
                      <div class="card-body">
                          <h5 class="card-title">Model in Use</h5>
                          <p class="card-text" spellcheck="false" id="currentModelIndicator">Using model for Trip from Tallinn, click settings to change Model If the trip to be predicted is from Helsinki</p><a href="#" class="btn btn-primary btn-sm" id="myBtn">Settings</a>
                      </div>
                  </div>
              </div>
          </div>

      </div>
      <footer class="footer pt-0 px-4">
          <div class="row align-items-center justify-content-lg-between">
              <div class="col-lg-6">
                  <div class="copyright text-center  text-lg-left  text-muted">
                      Â© 2021 Made with<a href="https://www.creative-tim.com/product/argon-dashboard" class="font-weight-bold ml-1" target="_blank">Argon Dashboard</a>
                  </div>
              </div>
              <div class="col-lg-6">
                  <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                      <li class="nav-item">
                          <a href="javascript:void(0);" class="nav-link">About us</a>
                      </li>
                      <li class="nav-item">
                          <a href="javascript:;" class="nav-link">Company</a>
                      </li>
                      <li class="nav-item">
                          <a href="javascript:;" class="nav-link">Blog</a>
                      </li>
                      <li class="nav-item">
                          <a href="javascript:;" class="nav-link">Contact</a>
                      </li>
                  </ul>
              </div>
          </div>
      </footer>
  </div>
  <script src="https://demos.creative-tim.com/argon-dashboard/assets/vendor/jquery/dist/jquery.min.js"></script>
  <script src="https://demos.creative-tim.com/argon-dashboard/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://demos.creative-tim.com/argon-dashboard/assets/vendor/js-cookie/js.cookie.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
  <script src="https://demos.creative-tim.com/argon-dashboard/assets/vendor/chart.js/dist/Chart.extension.js"></script>
  <script src="https://demos.creative-tim.com/argon-dashboard/assets/js/argon.min.js?v=1.2.0"></script>
        <!-- Load tensorflow.js -->
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
        <script>
          // Get the modal
            alert("Note : The default loaded model for prediction assumes the ship trip is from Tallinn, press 'settings' button to select the right model if current ship trip is from Helsinki");
            var modal = document.getElementById("myModal");

            // Get the button that opens the modal
            var btn = document.getElementById("myBtn");

            // Get the <span> element that closes the modal
            var span = document.getElementsByClassName("close")[0];

            // When the user clicks on the button, open the modal
            btn.onclick = function() {
            modal.style.display = "block";
            }

            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
            modal.style.display = "none";
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            }  

          var isDepartingFromHelsinki = false;
          var Threshold = 2.5;
          async function f() {
            fetch('https://meri.digitraffic.fi/api/v1/locations/latest/276829000')
              .then(response => response.json())
              .then(async function(data){
                    console.log(data)
                    var baseData = data.features[0]


                    var tensorInput = tf.tensor2d([baseData.geometry.coordinates[1], baseData.geometry.coordinates[0], baseData.properties.sog,baseData.properties.cog,baseData.properties.heading], [1,5]);

                    const model = await tf.loadLayersModel('https://sseun43.github.io/MegastarShipETAPrediction/helsinkiTripETA/model.json');
                    var helsinkiTripModel = model.predict(tensorInput).arraySync()[0][0]
                  
                    const fin_health_model = await tf.loadLayersModel('https://sseun43.github.io/MegastarShipETAPrediction/helsinkiTripETA/helsinkiTripHealth/model.json');
                    console.log(fin_health_model.predict(tf.tensor2d([60.1475,24.9149,2.8,197,205], [1,5]))/*.arraySync()[0][0]*/)
                    var helsinkiHealthModel = tf.metrics.meanAbsoluteError(fin_health_model.predict(tensorInput).arraySync()[0],tensorInput).arraySync()[0]

                    const est_eta_model = await tf.loadLayersModel('https://sseun43.github.io/MegastarShipETAPrediction/helsinkiTripETA/tallinnTripETA/model.json');
                    var tallinnTripModel = est_eta_model.predict(tensorInput).arraySync()[0][0]

                    const est_health_model = await tf.loadLayersModel('https://sseun43.github.io/MegastarShipETAPrediction/helsinkiTripETA/tallinnTripHealth/model.json');
                    console.log(est_health_model.predict(tf.tensor2d([60.1475,24.9149,2.8,197,205], [1,5]))/*.arraySync()[0][0]*/)
                    var tallinnHealthModel = tf.metrics.meanAbsoluteError(est_health_model.predict(tensorInput).arraySync()[0],tensorInput).arraySync()[0]

                    console.log(helsinkiTripModel,helsinkiHealthModel, tallinnTripModel, tallinnHealthModel)

                    function myFunction() {
                        var table = document.getElementById("myTable");
                        var row = table.insertRow(1);
                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        var cell4 = row.insertCell(3);
                        cell1.innerHTML = baseData.geometry.coordinates[1];
                        cell2.innerHTML = baseData.geometry.coordinates[0];
                        cell3.innerHTML = baseData.properties.sog;
                        cell4.innerHTML = baseData.properties.cog;

                        function addMinutes(minutes){
                            return new Date(new Date().getTime() + minutes*60000).toTimeString();
                        }

                        function displayWarning(){
                            var warningStatus = document.getElementById("warningStatus");
                            var normalStatus = document.getElementById("normalStatus");
                            
                            if(isDepartingFromHelsinki){
                                if(helsinkiHealthModel <= Threshold){
                                    warningStatus.style.display = "none"
                                    normalStatus.style.display = "block"
                                }else{
                                    normalStatus.style.display = "none"
                                    warningStatus.style.display = "block"
                                }
                            }else{
                                if(tallinnHealthModel <= Threshold){
                                    warningStatus.style.display = "none"
                                    normalStatus.style.display = "block"
                                }else{
                                    normalStatus.style.display = "none"
                                    warningStatus.style.display = "block"
                                }
                            }
                        }
                        displayWarning()

                        var eta = document.getElementById("ETA");
                        eta.innerHTML = (isDepartingFromHelsinki) ? addMinutes(helsinkiTripModel) : addMinutes(tallinnTripModel)
                    }
                    myFunction()
              });
          }
          f() // setTimeIntervalToCallThisFunction          

          function myCheckBoxFunction(){
            var checkbox = document.getElementById("myCheck");
            var currentModelInUse = document.getElementById("currentModelIndicator");
            var modelInd = document.getElementById("modelInd");
            var predictedCityInd = document.getElementById("predictedCityInd");
            // var lat = document.getElementById("Longitude");
            // var long = document.getElementById("Latitude");
            // var sog = document.getElementById("Speed");
            // var cog = document.getElementById("Course");
            // var heading = document.getElementById("Heading");

            if(checkbox.checked == true){
                isDepartingFromHelsinki = true;
                
                currentModelInUse.innerHTML = "Loaded model for Trip from Helsinki(Finland), click settings to change Model If the trip to be predicted is from Tallinn"
                modelInd.innerHTML = "Loaded model for Trip to Tallinn"
                predictedCityInd.innerHTML = "Predicted Time Of Arrival To Tallinn"
                console.log("isDepartingFromHelsink is true")
            }else{
                isDepartingFromHelsinki = false
                currentModelInUse.innerHTML = "Loaded model for Trip from Tallinn(Estonia), click settings to change Model If the trip to be predicted is from Helsinki"
                modelInd.innerHTML = "Loaded model for Trip to Helsinki"
                predictedCityInd.innerHTML = "Predicted Time Of Arrival To Helsinki"
                console.log("isDepartingFromHelsink is false")
            }
            f()
            
        }

        setInterval(f, 1000 * 60 * 2);
        </script>
</body>